#!/bin/bash -e
source /opt/app-root/etc/golang_environment

shopt -s dotglob

if [ -d /tmp/artifacts/ ]; then
    echo "---> Restoring build artifacts..."
    mv -v /tmp/artifacts/* ./
fi

echo "===> Build started at $(date)"

echo "---> Preparing source..."
mkdir -p $SOURCE
mv /tmp/src/* $SOURCE
pushd $SOURCE > /dev/null

if [ ! -d "./vendor/" ]; then
  if [ -f "./Gopkg.toml" ]; then
    echo "---> Using golang dep manager (found Gopkg.toml)"
  	echo "---> Downloading golang dep from github.com/golang/dep"
  	go get -u github.com/golang/dep/...
  	echo "---> Downloading dependencies (dep ensure)"
  	dep ensure
  else
    echo "---> Downloading dependencies (go get -v ./...)"
  	go get -v ./...
  fi
else
    echo "---> Downloading dependencies skipped because 'vendor/' directory is present"
fi

echo "---> Building application source..."
go install -v

echo "===> Build completed at $(date)"

# Fix source directory permissions
fix-permissions ./

popd >/dev/null
