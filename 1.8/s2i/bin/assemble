#!/bin/bash
set -e

APP_URI=${APP_URI:-"main"}
SOURCE=${GOPATH}/src/${APP_URI}

echo "===> Build started at $(date)"
START=$SECONDS

# Unconditionally print elapsed build time at exit
function finish {
  echo "===> Elapsed time: $(($SECONDS - $START)) seconds"
}
trap finish EXIT

echo "---> Preparing source..."
mkdir -p $SOURCE
mv /tmp/src/* $SOURCE
cd $SOURCE

if [ ! -d "./vendor/" ]; then
    echo "---> Downloading dependencies..."
	go get -v ./...
else
    echo "---> Downloading dependencies skipped because 'vendor/' directory is present."
fi

echo "---> Building application source..."
go install -v

echo "===> Build completed at $(date)"

# Fix source directory permissions
fix-permissions ./
